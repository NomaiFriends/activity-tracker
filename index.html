<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Трекер активностей</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-4">Трекер активностей</h1>
    <div id="auth" class="mb-4">
      <button id="signInButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Войти через Google</button>
      <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded hidden">Выйти</button>
      <div id="authStatus" class="text-red-400 mt-2"></div>
    </div>
    <div class="overflow-x-auto">
      <div id="calendar" class="bg-gray-800 p-4 rounded shadow"></div>
    </div>
    <div id="stats" class="mt-4 bg-gray-800 p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-2">Статистика</h2>
      <canvas id="weeklyChart" class="mb-4"></canvas>
      <canvas id="monthlyChart" class="mb-4"></canvas>
    </div>
  </div>

  <script>
    const CLIENT_ID = '328722452763-hlchkpo5etq87qqa56ivn6ie0l51mgb1.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    const activities = [
      { name: "Холодный душ по методу Вима Хофа", category: "Здоровье" },
      { name: "Мастурбация", category: "Здоровье" },
      { name: "Прослушивание аудиокниг", category: "Обучение" },
      { name: "Просмотр новостей и соцсетей", category: "Развлечения" },
      { name: "Написание сценария о движении Земли", category: "Творчество" },
      { name: "Снятие гитарных партий", category: "Творчество" },
      { name: "Запись кавера для чистой игры", category: "Творчество" },
      { name: "Занятия с метрономом и развитие ритма", category: "Творчество" },
      { name: "Сочинение музыки", category: "Творчество" },
      { name: "Поиск новой музыки", category: "Творчество" },
      { name: "Обучение ребят", category: "Обучение" },
      { name: "Просмотр обучающих видео по технике игры", category: "Обучение" },
      { name: "Занятия вокалом и игра на гитаре (кавера)", category: "Творчество" },
      { name: "Генерация порно-контента", category: "Развлечения" },
      { name: "Украшение квартиры мангой/плакатами", category: "Развлечения" },
      { name: "Работа", category: "Работа" },
      { name: "Глубокое общение на Reddit и поиск единомышленников", category: "Развлечения" }
    ];

    const today = new Date();
    const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
    const dayNames = ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"];
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();
    let data = {};
    let accessToken = null;
    let spreadsheetId = null;

    function initAuth() {
      console.log('Initializing auth...');
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          console.log('Token callback triggered:', tokenResponse);
          if (tokenResponse.error) {
            document.getElementById('authStatus').innerText = `Ошибка авторизации: ${tokenResponse.error_description || tokenResponse.error}`;
            console.error('Auth error:', tokenResponse);
            return;
          }
          accessToken = tokenResponse.access_token;
          console.log('Access token received:', accessToken);
          document.getElementById('signInButton').classList.add('hidden');
          document.getElementById('signOutButton').classList.remove('hidden');
          document.getElementById('authStatus').innerText = '';
          initGapi();
        }
      });
      document.getElementById('signInButton').onclick = () => {
        console.log('Requesting access token...');
        tokenClient.requestAccessToken({ prompt: 'consent' });
      };
      document.getElementById('signOutButton').onclick = () => {
        console.log('Signing out...');
        google.accounts.oauth2.revoke(accessToken, () => {
          accessToken = null;
          document.getElementById('signInButton').classList.remove('hidden');
          document.getElementById('signOutButton').classList.add('hidden');
          document.getElementById('calendar').innerHTML = 'Пожалуйста, войдите через Google.';
        });
      };
    }

    function initGapi() {
      if (!accessToken) {
        document.getElementById('authStatus').innerText = 'Токен отсутствует. Повторите вход.';
        console.error('No access token');
        return;
      }
      console.log('Loading GAPI client...');
      gapi.load('client', () => {
        console.log('Initializing GAPI...');
        gapi.client.init({
          apiKey: '', // Оставляем пустым, используем access_token
          discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
        }).then(() => {
          console.log('GAPI initialized, setting token:', accessToken);
          gapi.client.setToken({ access_token: accessToken });
          createSpreadsheet();
        }).catch(err => {
          document.getElementById('authStatus').innerText = `Ошибка инициализации API: ${err.message}`;
          console.error('GAPI init error:', err);
        });
      });
    }

    function createSpreadsheet() {
      if (!accessToken) {
        document.getElementById('authStatus').innerText = 'Токен отсутствует для создания таблицы.';
        console.error('No token for spreadsheet creation');
        return;
      }
      console.log('Creating spreadsheet...');
      gapi.client.sheets.spreadsheets.create({
        properties: { title: 'Activity Tracker ' + new Date().toLocaleDateString() }
      }).then(response => {
        spreadsheetId = response.result.spreadsheetId;
        console.log('Spreadsheet created, ID:', spreadsheetId);
        const headers = ['Date', ...activities.map(a => a.name)];
        gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: spreadsheetId,
          range: 'Sheet1!A1',
          valueInputOption: 'RAW',
          resource: { values: [headers] }
        }).then(() => loadData());
      }).catch(err => {
        document.getElementById('authStatus').innerText = `Ошибка создания таблицы: ${JSON.stringify(err, null, 2)}`;
        console.error('Spreadsheet creation error:', err);
      });
    }

    function loadData() {
      if (!spreadsheetId) {
        document.getElementById('authStatus').innerText = 'Таблица не создана.';
        console.error('No spreadsheet ID');
        return;
      }
      console.log('Loading data from spreadsheet:', spreadsheetId);
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: spreadsheetId,
        range: 'Sheet1!A2:Z1000'
      }).then(response => {
        const values = response.result.values || [];
        data = {};
        values.forEach(row => {
          if (row[0]) {
            const dateKey = row[0];
            data[dateKey] = row.slice(1).map(v => v ? parseInt(v) : '');
          }
        });
        generateCalendar();
      }).catch(err => {
        document.getElementById('authStatus').innerText = `Ошибка загрузки данных: ${err.message}`;
        console.error('Data load error:', err);
      });
    }

    function saveScore(day, activityIndex, value) {
      const dateKey = `${currentYear}-${currentMonth + 1}-${day}`;
      if (!data[dateKey]) data[dateKey] = Array(activities.length).fill('');
      data[dateKey][activityIndex] = value ? parseInt(value) : '';

      const row = [dateKey, ...data[dateKey]];
      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: spreadsheetId,
        range: 'Sheet1!A1',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: { values: [row] }
      }).then(() => updateStats()).catch(err => {
        document.getElementById('authStatus').innerText = `Ошибка сохранения: ${err.message}`;
        console.error('Save error:', err);
      });
    }

    function generateCalendar() {
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();

      let html = `<h2 class="text-xl font-semibold mb-2">${monthNames[currentMonth]} ${currentYear}</h2>`;
      html += `<table class="w-full border-collapse"><thead><tr><th class="p-2">Активность</th>`;
      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(currentYear, currentMonth, i);
        const dayName = dayNames[date.getDay()];
        html += `<th class="p-2">${dayName} ${i}</th>`;
      }
      html += `</tr></thead><tbody>`;

      activities.forEach((activity, index) => {
        html += `<tr><td class="p-2 border">${activity.name}</td>`;
        for (let i = 1; i <= daysInMonth; i++) {
          const dateKey = `${currentYear}-${currentMonth + 1}-${i}`;
          const score = data[dateKey]?.[index] || '';
          const isToday = i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
          let cellColor = '';
          if (score === 0) cellColor = 'bg-red-500';
          else if (score === 1) cellColor = 'bg-green-800';
          else if (score === 2) cellColor = 'bg-green-300';
          html += `<td class="p-2 border ${isToday ? 'bg-yellow-800' : ''} ${cellColor}">
            <select onchange="saveScore(${i}, ${index}, this.value)" class="w-16 p-1 bg-gray-700 text-white">
              <option value="" ${score === '' ? 'selected' : ''}></option>
              <option value="0" ${score === 0 ? 'selected' : ''}>0</option>
              <option value="1" ${score === 1 ? 'selected' : ''}>1</option>
              <option value="2" ${score === 2 ? 'selected' : ''}>2</option>
            </select>
          </td>`;
        }
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      html += `<div class="mt-4">
        <button onclick="prevMonth()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mr-2">Предыдущий</button>
        <button onclick="nextMonth()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Следующий</button>
      </div>`;
      document.getElementById('calendar').innerHTML = html;
      updateStats();
    }

    function updateStats() {
      const categories = {};
      activities.forEach((a, index) => {
        if (!categories[a.category]) categories[a.category] = [];
        categories[a.category].push(index);
      });

      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      let weeks = [];
      let currentWeek = [];
      for (let i = 1; i <= daysInMonth; i++) {
        currentWeek.push(i);
        if (new Date(currentYear, currentMonth, i).getDay() === 6 || i === daysInMonth) {
          weeks.push(currentWeek);
          currentWeek = [];
        }
      }
      const weeklyData = {};
      weeks.forEach((week, idx) => {
        weeklyData[`Неделя ${idx + 1}`] = {};
        for (let cat in categories) {
          weeklyData[`Неделя ${idx + 1}`][cat] = 0;
          categories[cat].forEach(index => {
            let total = 0, count = 0;
            week.forEach(day => {
              const dateKey = `${currentYear}-${currentMonth + 1}-${day}`;
              if (data[dateKey] && data[dateKey][index] !== '' && data[dateKey][index] !== undefined) {
                total += data[dateKey][index];
                count++;
              }
            });
            weeklyData[`Неделя ${idx + 1}`][cat] += count > 0 ? total / count : 0;
          });
          weeklyData[`Неделя ${idx + 1}`][cat] /= categories[cat].length || 1;
        }
      });

      const monthlyData = {};
      for (let cat in categories) {
        monthlyData[cat] = 0;
        categories[cat].forEach(index => {
          let total = 0, count = 0;
          for (let key in data) {
            if (key.startsWith(`${currentYear}-${currentMonth + 1}-`) && data[key][index] !== '' && data[key][index] !== undefined) {
              total += data[key][index];
              count++;
            }
          }
          monthlyData[cat] += count > 0 ? total / count : 0;
        });
        monthlyData[cat] /= categories[cat].length || 1;
      }

      const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
      new Chart(weeklyCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(weeklyData),
          datasets: Object.keys(categories).map(cat => ({
            label: cat,
            data: Object.values(weeklyData).map(w => w[cat]),
            backgroundColor: getCategoryColor(cat),
            borderColor: getCategoryColor(cat),
            borderWidth: 1
          }))
        },
        options: {
          scales: { y: { beginAtZero: true, max: 2, ticks: { stepSize: 0.5 } } },
          plugins: { legend: { display: true } }
        }
      });

      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(monthlyData),
          datasets: [{
            label: 'Средний балл',
            data: Object.values(monthlyData),
            backgroundColor: Object.keys(monthlyData).map(cat => getCategoryColor(cat)),
            borderColor: Object.keys(monthlyData).map(cat => getCategoryColor(cat)),
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, max: 2, ticks: { stepSize: 0.5 } } },
          plugins: { legend: { display: false } }
        }
      });
    }

    function getCategoryColor(category) {
      const colors = {
        "Здоровье": "#ef4444",
        "Обучение": "#8b5cf6",
        "Творчество": "#f59e0b",
        "Развлечения": "#10b981",
        "Работа": "#3b82f6"
      };
      return colors[category] || "#d1d5db";
    }

    function prevMonth() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      generateCalendar();
    }

    function nextMonth() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      generateCalendar();
    }

    window.onload = () => {
      console.log('Window loaded, loading GAPI...');
      const script = document.createElement('script');
      script.src = 'https://apis.google.com/js/api.js';
      script.onload = () => {
        console.log('GAPI script loaded, initializing auth...');
        initAuth();
      };
      document.body.appendChild(script);
    };
  </script>
</body>
</html>
